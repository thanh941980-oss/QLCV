<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Công Văn Đến - Hệ Thống Quản Lý Công Văn</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background-color: #f4f6f9; font-size: 13px; }
    .card { margin-bottom: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .card-header { background: #1a73e8; color: #fff; font-weight: 600; }
    .btn i { margin-right: 4px; }
    table th { background: #f8f9fa; text-align: center; font-size: 13px; }
    table td { vertical-align: middle; font-size: 13px; }
    .action-btn { border: none; background: transparent; cursor: pointer; padding: 4px 8px; }
    .action-btn.edit { color: #1a73e8; }
    .action-btn.delete { color: #dc3545; }
    .notification { position: fixed; top: 20px; right: 20px; padding: 12px 18px; border-radius: 8px; color: #fff; display: none; z-index: 2000; }
    .notification.success { background: #28a745; }
    .notification.error { background: #dc3545; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-primary"><i class="fa-solid fa-inbox"></i> Quản lý Công văn đến</h2>
      <a href="dashboard.html" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left"></i> Quay lại
      </a>
    </div>

    <!-- Thông tin công văn -->
    <div class="card">
  <div class="card-header">Thông tin công văn đến</div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Năm</label>
        <div class="input-group">
          <select id="nam" class="form-select">
            <option value="">Chọn năm</option>
            <option>2023</option><option>2024</option><option>2025</option><option>2026</option>
          </select>
          <button class="btn btn-outline-primary" id="them-nam-btn"><i class="fa fa-plus"></i></button>
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Số đến</label>
        <input type="text" id="so-den" class="form-control" placeholder="Nhập số đến">
      </div>

      <div class="col-md-6">
        <label class="form-label">Người nhận</label>
        <div class="input-group">
          <select id="nguoi-nhan" class="form-select">
            <option value="">Chọn người nhận</option>
            <option>Nguyễn Văn A</option><option>Trần Thị B</option><option>Lê Văn C</option>
          </select>
          <button class="btn btn-outline-primary" id="them-nguoi-nhan-btn"><i class="fa fa-plus"></i></button>
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Ngày nhận</label>
        <input type="date" id="ngay-nhan" class="form-control">
      </div>

      <div class="col-md-6">
        <label class="form-label">Số công văn</label>
        <input type="text" id="so-cong-van" class="form-control" placeholder="Nhập số công văn">
      </div>

      <div class="col-md-6">
        <label class="form-label">Tên văn bản</label>
        <div class="input-group">
          <select id="ten-van-ban" class="form-select">
            <option value="">Chọn tên văn bản</option>
            <option>Công văn hỏa tốc</option>
            <option>Công văn thường</option>
            <option>Công văn mật</option>
          </select>
          <button class="btn btn-outline-primary" id="them-ten-van-ban-btn"><i class="fa fa-plus"></i></button>
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Ngày ký</label>
        <input type="date" id="ngay-ky" class="form-control">
      </div>

      <div class="col-md-6">
        <label class="form-label">Người ký</label>
        <div class="input-group">
          <select id="nguoi-ky" class="form-select">
            <option value="">Chọn người ký</option>
            <option>Nguyễn Văn A</option><option>Trần Thị B</option><option>Lê Văn C</option>
          </select>
          <button class="btn btn-outline-primary" id="them-nguoi-ky-btn"><i class="fa fa-plus"></i></button>
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Nơi ban hành</label>
        <div class="input-group">
          <select id="noi-ban-hanh" class="form-select">
            <option value="">Chọn nơi ban hành</option>
            <option>Phòng Tổ chức</option><option>Phòng Kế hoạch</option><option>Phòng Tài chính</option>
          </select>
          <button class="btn btn-outline-primary" id="them-noi-ban-hanh-btn"><i class="fa fa-plus"></i></button>
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Số tờ</label>
        <input type="text" id="so-to" class="form-control" placeholder="Nhập số tờ">
      </div>

      <!-- Nội dung full width -->
      <div class="col-12">
        <label class="form-label">Nội dung</label>
        <textarea id="noi-dung" class="form-control" rows="4" placeholder="Nhập nội dung công văn"></textarea>
      </div>

      <!-- File full width -->
      <div class="col-12">
        <label class="form-label">File đính kèm</label>
        <input type="file" id="file-dinh-kem" class="form-control">
      </div>
    </div>
  </div>
</div>

    <!-- Nút hành động -->
    <div class="d-flex justify-content-end gap-2 mb-4">
      <button class="btn btn-secondary" id="reset-cvden-btn"><i class="fa fa-rotate"></i> Làm mới</button>
      <button class="btn btn-primary" id="save-cvden-btn"><i class="fa fa-save"></i> Lưu công văn</button>
      <button class="btn btn-warning text-white" id="update-cvden-btn"><i class="fa fa-pen"></i> Cập nhật</button>
    </div>

    <!-- Danh sách công văn -->
    <div class="card">
      <div class="card-header">Danh sách công văn đến</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-striped table-hover align-middle" id="documentsTable">
            <thead>
              <tr>
                <th>STT</th><th>Năm</th><th>Số đến</th><th>Người nhận</th><th>Ngày nhận</th>
                <th>Số CV</th><th>Tên VB</th><th>Ngày ký</th><th>Người ký</th><th>Nơi BH</th><th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="documentsBody">
              <tr><td colspan="11" class="text-center">Chưa có công văn nào</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="successNotification" class="notification success"></div>
  <div id="errorNotification" class="notification error"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBWKTyXVK1y2dqxWUWprIxd5CCHMzSMc_o",
      authDomain: "quan-ly-cong-van-dede3.firebaseapp.com",
      databaseURL: "https://quan-ly-cong-van-dede3-default-rtdb.firebaseio.com",
      projectId: "quan-ly-cong-van-dede3",
      storageBucket: "quan-ly-cong-van-dede3.firebasestorage.app",
      messagingSenderId: "1080528314069",
      appId: "1:1080528314069:web:831f1b3c497ba082f80c5c"
    };

    // Khởi tạo Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // Biến toàn cục
    let currentUser = null;
    let editingId = null;

    // Hiển thị thông báo
    function showNotification(message, isSuccess = true) {
      const notification = document.getElementById(isSuccess ? 'successNotification' : 'errorNotification');
      notification.textContent = message;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    // Làm mới form
    function refreshForm() {
      document.getElementById('nam').value = '';
      document.getElementById('so-den').value = '';
      document.getElementById('nguoi-nhan').value = '';
      document.getElementById('ngay-nhan').valueAsDate = new Date();
      document.getElementById('so-cong-van').value = '';
      document.getElementById('ten-van-ban').value = '';
      document.getElementById('ngay-ky').valueAsDate = new Date();
      document.getElementById('nguoi-ky').value = '';
      document.getElementById('noi-ban-hanh').value = '';
      document.getElementById('so-to').value = '';
      document.getElementById('noi-dung').value = '';
      document.getElementById('file-dinh-kem').value = '';
      editingId = null;
      document.getElementById('update-cvden-btn').style.display = 'none';
      document.getElementById('save-cvden-btn').style.display = 'block';
    }

    // Lưu công văn đến
    async function saveDocument() {
      const year = document.getElementById('nam').value;
      const soDen = document.getElementById('so-den').value;
      const nguoiNhan = document.getElementById('nguoi-nhan').value;
      const ngayNhan = document.getElementById('ngay-nhan').value;
      const soCongVan = document.getElementById('so-cong-van').value;
      const tenVanBan = document.getElementById('ten-van-ban').value;
      const ngayKy = document.getElementById('ngay-ky').value;
      const nguoiKy = document.getElementById('nguoi-ky').value;
      const noiBanHanh = document.getElementById('noi-ban-hanh').value;
      const soTo = document.getElementById('so-to').value;
      const content = document.getElementById('noi-dung').value;
      const fileInput = document.getElementById('file-dinh-kem');
      const fileName = fileInput.files[0] ? fileInput.files[0].name : '';

      // Kiểm tra dữ liệu đầu vào
      if (!year || !soDen || !nguoiNhan || !ngayNhan || !soCongVan || !tenVanBan || !ngayKy || !nguoiKy || !noiBanHanh || !content) {
        showNotification('Vui lòng điền đầy đủ thông tin', false);
        return;
      }

      try {
        const documentData = {
          year,
          soDen,
          nguoiNhan,
          ngayNhan,
          soCongVan,
          tenVanBan,
          ngayKy,
          nguoiKy,
          noiBanHanh,
          soTo,
          content,
          fileName,
          createdAt: new Date().toISOString(),
          createdBy: currentUser.email
        };

        if (editingId) {
          // Cập nhật công văn đã có
          await set(ref(database, `congVanDen/${editingId}`), documentData);
          showNotification('Cập nhật công văn thành công!');
        } else {
          // Thêm công văn mới
          const newDocRef = push(ref(database, 'congVanDen'));
          await set(newDocRef, documentData);
          showNotification('Thêm công văn thành công!');
        }

        refreshForm();
      } catch (error) {
        console.error('Lỗi khi lưu công văn:', error);
        showNotification('Có lỗi xảy ra khi lưu công văn', false);
      }
    }

    // Xóa công văn
    async function deleteDocument(id) {
      if (!confirm('Bạn có chắc chắn muốn xóa công văn này?')) return;
      
      try {
        await remove(ref(database, `congVanDen/${id}`));
        showNotification('Xóa công văn thành công!');
      } catch (error) {
        console.error('Lỗi khi xóa công văn:', error);
        showNotification('Có lỗi xảy ra khi xóa công văn', false);
      }
    }

    // Chỉnh sửa công văn
    function editDocument(id, data) {
      document.getElementById('nam').value = data.year;
      document.getElementById('so-den').value = data.soDen;
      document.getElementById('nguoi-nhan').value = data.nguoiNhan;
      document.getElementById('ngay-nhan').value = data.ngayNhan;
      document.getElementById('so-cong-van').value = data.soCongVan;
      document.getElementById('ten-van-ban').value = data.tenVanBan;
      document.getElementById('ngay-ky').value = data.ngayKy;
      document.getElementById('nguoi-ky').value = data.nguoiKy;
      document.getElementById('noi-ban-hanh').value = data.noiBanHanh;
      document.getElementById('so-to').value = data.soTo;
      document.getElementById('noi-dung').value = data.content;
      
      editingId = id;
      document.getElementById('update-cvden-btn').style.display = 'block';
      document.getElementById('save-cvden-btn').style.display = 'none';
      
      // Cuộn lên đầu form
      window.scrollTo(0, 0);
    }

    // Hiển thị danh sách công văn
    function displayDocuments(snapshot) {
      const documentsBody = document.getElementById('documentsBody');
      documentsBody.innerHTML = '';
      
      if (!snapshot.exists()) {
        documentsBody.innerHTML = '<tr><td colspan="11" style="text-align: center;">Chưa có công văn nào</td></tr>';
        return;
      }
      
      const documents = snapshot.val();
      let stt = 1;
      
      for (const id in documents) {
        const doc = documents[id];
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${stt}</td>
          <td>${doc.year}</td>
          <td>${doc.soDen}</td>
          <td>${doc.nguoiNhan}</td>
          <td>${doc.ngayNhan}</td>
          <td>${doc.soCongVan}</td>
          <td>${doc.tenVanBan}</td>
          <td>${doc.ngayKy}</td>
          <td>${doc.nguoiKy}</td>
          <td>${doc.noiBanHanh}</td>
          <td>
            <a class="action-icon" onclick="window.editDocument('${id}', ${JSON.stringify(doc).replace(/"/g, '&quot;')})">Sửa</a>
            <a class="action-icon delete-icon" onclick="window.deleteDocument('${id}')">Xóa</a>
          </td>
        `;
        
        documentsBody.appendChild(row);
        stt++;
      }
    }

    // Thêm mới option và lưu vào Firebase
    async function themMoi(selectId, category) {
      const tenMoi = prompt('Nhập giá trị mới:');
      if (tenMoi && tenMoi.trim() !== '') {
        try {
          const tenMoiTrimmed = tenMoi.trim();
          
          // Kiểm tra trùng lặp
          const select = document.getElementById(selectId);
          for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value === tenMoiTrimmed) {
              showNotification('Giá trị này đã tồn tại!', false);
              return;
            }
          }

          // Tạo dữ liệu để lưu
          const newData = {
            name: tenMoiTrimmed,
            createdAt: new Date().toISOString(),
            createdBy: currentUser ? currentUser.email : 'unknown'
          };
          
          // Lưu vào Firebase
          const newItemRef = push(ref(database, `categories/${category}`));
          await set(newItemRef, newData);
          
          // Thêm vào dropdown
          const option = document.createElement('option');
          option.value = tenMoiTrimmed;
          option.textContent = tenMoiTrimmed;
          select.appendChild(option);
          select.value = tenMoiTrimmed;
          
          showNotification('Thêm mới thành công!');
          
        } catch (error) {
          console.error('Lỗi khi thêm mới:', error);
          showNotification('Có lỗi xảy ra khi thêm mới', false);
        }
      } else if (tenMoi !== null) {
        showNotification('Vui lòng nhập giá trị hợp lệ!', false);
      }
    }

    // Tải danh sách các option từ Firebase
    function loadCategories(selectId, category) {
      const categoriesRef = ref(database, `categories/${category}`);
      onValue(categoriesRef, (snapshot) => {
        const select = document.getElementById(selectId);
        
        // Giữ lại các option mặc định (những option đầu tiên)
        const defaultOptions = [];
        for (let i = 0; i < select.options.length; i++) {
          defaultOptions.push(select.options[i]);
        }
        
        // Xóa tất cả options
        select.innerHTML = '';
        
        // Thêm lại các option mặc định
        defaultOptions.forEach(option => {
          select.appendChild(option);
        });
        
        // Thêm các option từ Firebase
        if (snapshot.exists()) {
          const categories = snapshot.val();
          for (const key in categories) {
            const categoryItem = categories[key];
            const option = document.createElement('option');
            option.value = categoryItem.name;
            option.textContent = categoryItem.name;
            select.appendChild(option);
          }
        }
      });
    }

    // Kiểm tra kết nối Firebase
    function checkDatabaseConnection() {
      const connectedRef = ref(database, ".info/connected");
      onValue(connectedRef, (snap) => {
        if (snap.val() === true) {
          console.log("Đã kết nối đến Firebase");
        } 
        //else {
        //  console.log("Mất kết nối Firebase");
        //  showNotification("Mất kết nối đến server", false);
        //}
      });
    }

    // Khởi tạo trang
    document.addEventListener('DOMContentLoaded', function() {
      // Thiết lập ngày mặc định
      const today = new Date();
      document.getElementById('ngay-nhan').valueAsDate = today;
      document.getElementById('ngay-ky').valueAsDate = today;
      
      // Ẩn nút cập nhật ban đầu
      document.getElementById('update-cvden-btn').style.display = 'none';
      
      // Xử lý sự kiện nút làm mới
      document.getElementById('reset-cvden-btn').addEventListener('click', refreshForm);
      
      // Xử lý sự kiện nút lưu
      document.getElementById('save-cvden-btn').addEventListener('click', saveDocument);
      
      // Xử lý sự kiện nút cập nhật
      document.getElementById('update-cvden-btn').addEventListener('click', saveDocument);
      
      // Xử lý sự kiện nút thêm mới
      document.getElementById('them-nam-btn').addEventListener('click', () => themMoi('nam', 'years'));
      document.getElementById('them-nguoi-nhan-btn').addEventListener('click', () => themMoi('nguoi-nhan', 'receivers'));
      document.getElementById('them-ten-van-ban-btn').addEventListener('click', () => themMoi('ten-van-ban', 'documentTypes'));
      document.getElementById('them-nguoi-ky-btn').addEventListener('click', () => themMoi('nguoi-ky', 'signers'));
      document.getElementById('them-noi-ban-hanh-btn').addEventListener('click', () => themMoi('noi-ban-hanh', 'issuingPlaces'));
      
      // Kiểm tra kết nối
      checkDatabaseConnection();
      
      // Kiểm tra trạng thái đăng nhập
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          
          // Tải các danh mục từ Firebase
          loadCategories('nam', 'years');
          loadCategories('nguoi-nhan', 'receivers');
          loadCategories('ten-van-ban', 'documentTypes');
          loadCategories('nguoi-ky', 'signers');
          loadCategories('noi-ban-hanh', 'issuingPlaces');
          
          // Hiển thị loading
          document.getElementById('loading').style.display = 'block';
          
          // Lấy dữ liệu công văn đến từ Firebase
          const documentsRef = ref(database, 'congVanDen');
          onValue(documentsRef, (snapshot) => {
            document.getElementById('loading').style.display = 'none';
            displayDocuments(snapshot);
          }, (error) => {
            document.getElementById('loading').style.display = 'none';
            console.error('Lỗi khi tải dữ liệu:', error);
            showNotification('Có lỗi xảy ra khi tải dữ liệu', false);
          });
        } else {
          window.location.href = 'index.html';
        }
      });
    });

    // Cho phép sử dụng các hàm toàn cục
    window.editDocument = editDocument;
    window.deleteDocument = deleteDocument;
    window.themMoi = themMoi;
  </script>
</body>

</html>



